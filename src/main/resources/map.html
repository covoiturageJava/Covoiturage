<!DOCTYPE html>
<html>
<head>
    <title>Carte avec Itinéraire</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
        #controls {
            margin: 10px;
            text-align: center;
        }
        #coordinates {
            margin-top: 10px;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="controls">
    <button id="locate-user">Localiser l'utilisateur</button>
    <button id="select-start" class="hidden">Sélectionner le départ</button>
    <button id="select-end" class="hidden">Sélectionner la destination</button>
    <p id="coordinates">Coordonnées: Non sélectionnées</p>
</div>
<div id="map"></div>
<script>
    var map = L.map('map').setView([34.020874, -6.841679], 14);
    // Ajouter une couche OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var selectionMode = null;
    var startPoint = null;
    var endPoint = null;

    // Localiser l'utilisateur
    document.getElementById('locate-user').addEventListener('click', function () {
        if (!navigator.geolocation) {
            alert("La géolocalisation n'est pas prise en charge par votre navigateur.");
            return;
        }

        navigator.geolocation.getCurrentPosition(function (position) {
            var userCoords = [position.coords.latitude, position.coords.longitude];
            L.marker(userCoords).addTo(map).bindPopup("Vous êtes ici").openPopup();
            map.setView(userCoords, 14);
            document.getElementById('select-start').classList.remove('hidden');
        });
    });

    // Sélectionner le point de départ
    document.getElementById('select-start').addEventListener('click', function () {
        selectionMode = 'start';
        this.classList.add('hidden');
        document.getElementById('select-end').classList.remove('hidden');
        document.getElementById('coordinates').textContent = "Sélectionnez le point de départ sur la carte.";
    });

    // Sélectionner le point de destination
    document.getElementById('select-end').addEventListener('click', function () {
        selectionMode = 'end';
        this.classList.add('hidden');
        document.getElementById('coordinates').textContent = "Sélectionnez la destination sur la carte.";
    });

    // Gestion des clics sur la carte
    map.on('click', function (e) {
        var coords = e.latlng;

        if (selectionMode === 'start') {
            startPoint = [coords.lat, coords.lng];
            L.marker(startPoint, { color: 'green' }).addTo(map).bindPopup("Point de départ").openPopup();
            document.getElementById('coordinates').textContent =
                `Départ: Latitude ${coords.lat.toFixed(6)}, Longitude ${coords.lng.toFixed(6)}`;
            selectionMode = null;
        } else if (selectionMode === 'end') {
            endPoint = [coords.lat, coords.lng];
            L.marker(endPoint, { color: 'red' }).addTo(map).bindPopup("Destination").openPopup();
            document.getElementById('coordinates').textContent =
                `Destination: Latitude ${coords.lat.toFixed(6)}, Longitude ${coords.lng.toFixed(6)}`;
            if (startPoint) {
                calculateAndDisplayRoute(startPoint, endPoint);
            }
            selectionMode = null;
        }
    });

    // Calcul et affichage de l'itinéraire
    function calculateAndDisplayRoute(start, end) {
        var osrmUrl = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;

        fetch(osrmUrl)
            .then(response => response.json())
            .then(data => {
                if (data.routes.length > 0) {
                    var routeCoordinates = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    var routeLine = L.polyline(routeCoordinates, { color: 'blue', weight: 4 }).addTo(map);
                    map.fitBounds(routeLine.getBounds());
                    document.getElementById('coordinates').textContent = "Itinéraire affiché.";
                } else {
                    alert("Aucun itinéraire trouvé.");
                }
            })
            .catch(error => alert("Erreur lors du calcul de l'itinéraire : " + error));
    }
</script>
</body>
</html>
